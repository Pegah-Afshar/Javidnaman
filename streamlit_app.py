import streamlit as st
from streamlit_gsheets import GSheetsConnection
import pandas as pd

# 1. Page Configuration
st.set_page_config(page_title="Ø«Ø¨Øª Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª", layout="wide")

# 2. RTL Styling for Farsi
st.markdown("""
    <style>
    [data-testid="stAppViewContainer"] { direction: rtl; text-align: right; }
    label, .stSelectbox, .stTextInput, .stTextArea { direction: rtl !important; text-align: right !important; }
    .stButton button { display: block; margin-right: 0; margin-left: auto; background-color: #4CAF50; color: white; }
    div[data-testid="stExpander"] { text-align: right; direction: rtl; }
    .stMetric { text-align: right; }
    </style>
    """, unsafe_allow_html=True)

st.title("ğŸ“‹ Ù¾Ù†Ù„ Ø¬Ø§Ù…Ø¹ Ø«Ø¨Øª Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª")

# 3. Connect to Google Sheets
try:
    spreadsheet_url = st.secrets["public_gsheets_url"]
    conn = st.connection("gsheets", type=GSheetsConnection)
    df = conn.read(spreadsheet=spreadsheet_url, ttl=0)
except Exception as e:
    st.error("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú¯ÙˆÚ¯Ù„â€ŒØ´ÛŒØª. Ù„Ø·ÙØ§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Secrets Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.")
    st.stop()

# 4. Search & Dropdown Section
names_list = df['Ø§Ø³Ù…'].dropna().unique().tolist()

c_top1, c_top2 = st.columns([3, 1])
with c_top1:
    search_query = st.selectbox(
        "ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ù†Ø§Ù… (ØªØ§ÛŒÙ¾ Ú©Ù†ÛŒØ¯ ØªØ§ Ù„ÛŒØ³Øª ÙÛŒÙ„ØªØ± Ø´ÙˆØ¯):", 
        ["+ Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯"] + names_list
    )
with c_top2:
    st.metric("ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ø§ÙØ±Ø§Ø¯", len(df))

# 5. The Main Form
with st.form("main_form"):
    if search_query == "+ Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯":
        st.subheader("âœ¨ Ø«Ø¨Øª ÙˆØ±ÙˆØ¯ÛŒ Ø¬Ø¯ÛŒØ¯")
        v_name = st.text_input("Ø§Ø³Ù…")
    else:
        st.subheader(f"ğŸ”„ ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª: {search_query}")
        # Get existing data for the selected name
        user_data = df[df['Ø§Ø³Ù…'] == search_query].iloc[0]
        v_name = search_query
        st.info("Ø¯Ø± Ø­Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ÙˆØ¬ÙˆØ¯. ØªØºÛŒÛŒØ±Ø§Øª Ø±Ø§ Ø§Ø¹Ù…Ø§Ù„ Ùˆ Ø¯Ú©Ù…Ù‡ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.")

    # --- Section 1: Personal Info ---
    st.markdown("### ğŸ‘¤ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ")
    col1, col2, col3 = st.columns(3)
    with col1: 
        v_bday = st.text_input("ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯", value="" if search_query=="+ Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯" else str(user_data.get("ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯", "")))
    with col2: 
        v_age = st.text_input("Ø³Ù†", value="" if search_query=="+ Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯" else str(user_data.get("Ø³Ù†", "")))
    with col3: 
        v_gender = st.text_input("Ø¬Ù†Ø³ÛŒØª", value="" if search_query=="+ Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯" else str(user_data.get("Ø¬Ù†Ø³ÛŒØª", "")))
    
    col_birth1, col_birth2 = st.columns(2)
    with col_birth1:
        v_birth_place = st.text_input("Ù…Ø­Ù„ ØªÙˆÙ„Ø¯", value="" if search_query=="+ Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯" else str(user_data.get("Ù…Ø­Ù„ ØªÙˆÙ„Ø¯", "")))
    with col_birth2:
        v_city_base = st.text_input("Ø´Ù‡Ø±", value="" if search_query=="+ Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯" else str(user_data.get("Ø´Ù‡Ø±", "")))

    st.divider()

    # --- Section 2: Details of Incident ---
    st.markdown("### ğŸ” Ø¬Ø²Ø¦ÛŒØ§Øª ÙˆØ§Ù‚Ø¹Ù‡")
    col4, col5, col6 = st.columns(3)
    with col4: 
        v_province = st.text_input("Ø§Ø³ØªØ§Ù†", value="" if search_query=="+ Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯" else str(user_data.get("Ø§Ø³ØªØ§Ù†", "")))
    with col5: 
        v_district = st.text_input("Ù…Ø­Ù„Ù‡", value="" if search_query=="+ Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯" else str(user_data.get("Ù…Ø­Ù„Ù‡", "")))
    with col6: 
        v_street = st.text_input("Ø®ÛŒØ§Ø¨Ø§Ù†", value="" if search_query=="+ Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯" else str(user_data.get("Ø®ÛŒØ§Ø¨Ø§Ù†", "")))
    
    col_incident1, col_incident2 = st.columns(2)
    with col_incident1:
        v_date = st.text_input("ØªØ§Ø±ÛŒØ®", value="" if search_query=="+ Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯" else str(user_data.get("ØªØ§Ø±ÛŒØ®", "")))
    with col_incident2:
        v_exact_loc = st.text_input("Ù…Ø­Ù„ Ø¯Ù‚ÛŒÙ‚ Ú©Ø´ØªÙ‡ Ø´Ø¯Ù†", value="" if search_query=="+ Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯" else str(user_data.get("Ù…Ø­Ù„ Ø¯Ù‚ÛŒÙ‚ Ú©Ø´ØªÙ‡ Ø´Ø¯Ù†", "")))
    
    v_method = st.text_input("Ø·Ø±ÛŒÙ‚Ù‡â€ŒÛŒ Ú©Ø´ØªÙ‡ Ø´Ø¯Ù†", value="" if search_query=="+ Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯" else str(user_data.get("Ø·Ø±ÛŒÙ‚Ù‡â€ŒÛŒ Ú©Ø´ØªÙ‡ Ø´Ø¯Ù†", "")))
    v_grave = st.text_input("Ø¢Ø±Ø§Ù…Ú¯Ø§Ù‡", value="" if search_query=="+ Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯" else str(user_data.get("Ø¢Ø±Ø§Ù…Ú¯Ø§Ù‡", "")))

    st.divider()

    # --- Section 3: Additional Info ---
    st.markdown("### ğŸŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ")
    v_social = st.text_input("Ø§Ú©Ø§Ù†Øª Ø¯Ø± Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ", value="" if search_query=="+ Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯" else str(user_data.get("Ø§Ú©Ø§Ù†Øª Ø¯Ø± Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ", "")))
    v_relatives = st.text_input("Ø¨Ø³ØªÚ¯Ø§Ù† Ø¯Ø± Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ", value="" if search_query=="+ Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯" else str(user_data.get("Ø¨Ø³ØªÚ¯Ø§Ù† Ø¯Ø± Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ", "")))
    
    v_date_en = st.text_input("ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ", value="" if search_query=="+ Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯" else str(user_data.get("ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ", "")))
    v_notes = st.text_area("ØªÙˆØ¶ÛŒØ­Ø§Øª", value="" if search_query=="+ Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯" else str(user_data.get("ØªÙˆØ¶ÛŒØ­Ø§Øª", "")))

    # 6. Submit Button Logic
    submit_label = "ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¬Ø¯ÛŒØ¯" if search_query == "+ Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯" else "âœ… Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØºÛŒÛŒØ±Ø§Øª"
    submit = st.form_submit_button(submit_label)

    if submit:
        # Construct dictionary
        updated_dict = {
            "Ø§Ø³Ù…": v_name, "Ø´Ù‡Ø±": v_city_base, "Ù…Ø­Ù„Ù‡": v_district, "Ø®ÛŒØ§Ø¨Ø§Ù†": v_street, 
            "Ø§Ø³ØªØ§Ù†": v_province, "ØªØ§Ø±ÛŒØ®": v_date, "ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ": v_date_en, 
            "Ø³Ù†": v_age, "Ø¬Ù†Ø³ÛŒØª": v_gender, "ØªÙˆØ¶ÛŒØ­Ø§Øª": v_notes, 
            "Ù…Ø­Ù„ Ø¯Ù‚ÛŒÙ‚ Ú©Ø´ØªÙ‡ Ø´Ø¯Ù†": v_exact_loc, "Ø·Ø±ÛŒÙ‚Ù‡â€ŒÛŒ Ú©Ø´ØªÙ‡ Ø´Ø¯Ù†": v_method, 
            "Ø¢Ø±Ø§Ù…Ú¯Ø§Ù‡": v_grave, "Ù…Ø­Ù„ ØªÙˆÙ„Ø¯": v_birth_place, "ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯": v_bday, 
            "Ø§Ú©Ø§Ù†Øª Ø¯Ø± Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ": v_social, "Ø¨Ø³ØªÚ¯Ø§Ù† Ø¯Ø± Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ": v_relatives
        }
        
        # Validation Gatekeeper
        if not v_name or v_name.strip() == "" or v_name == "+ Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯":
            st.error("âš ï¸ Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…: ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† 'Ø§Ø³Ù…' Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.")
        else:
            if search_query == "+ Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯":
                if v_name in names_list:
                    st.error("Ø§ÛŒÙ† Ø§Ø³Ù… Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø± Ù„ÛŒØ³Øª Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¢Ù† Ø±Ø§ Ø§Ø² Ù„ÛŒØ³Øª Ø¨Ø§Ù„Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯Ù‡ Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯.")
                else:
                    new_row = pd.DataFrame([updated_dict])
                    df = pd.concat([df, new_row], ignore_index=True)
                    conn.update(data=df)
                    st.success(f"Ø§Ø·Ù„Ø§Ø¹Ø§Øª '{v_name}' Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.")
                    st.balloons()
            else:
                # Update existing row
                df.loc[df['Ø§Ø³Ù…'] == search_query, list(updated_dict.keys())] = list(updated_dict.values())
                conn.update(data=df)
                st.success("Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.")
